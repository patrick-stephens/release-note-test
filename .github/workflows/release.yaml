---
    name: CI - release
    on:
        push:
            tags:
                - 'v*'

    jobs:
        releases:
            name: Create release
            runs-on: ubuntu-latest
            permissions:
                contents: write
            steps:
                - uses: actions/checkout@v4

                - name: test files
                  run: |
                    echo "${{ github.ref_name }}" > metadata.json
                  shell: bash

                - name: Create release
                  if: ${{ startsWith(github.ref, 'refs/tags/v') }}
                  # This may fail for workflow_dispatch if the release already exists
                  uses: softprops/action-gh-release@v2
                  with:
                    body: |
                        Calyptia Core release for ${{ github.ref_name }} version
                    append_body: true
                    files: |
                        metadata.json
                    fail_on_unmatched_files: false
                    generate_release_notes: true
                    # Prevent overuse of CI_PAT leading to rate limiting, if we're the current repo we can use the ephemeral token
                    token: ${{ secrets.GITHUB_TOKEN }}
                    tag_name: ${{ github.ref_name }}